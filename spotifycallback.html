<script>
(async () => {
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');
  const storedVerifier = localStorage.getItem('spotify_code_verifier');

  if (!code || !storedVerifier) {
    document.body.textContent = 'Missing code or verifier. Try logging in again.';
    return;
  }

  const response = await fetch('https://accounts.spotify.com/api/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      client_id: CLIENT_ID,
      grant_type: 'authorization_code',
      code,
      redirect_uri: REDIRECT_URI,
      code_verifier: storedVerifier,
    })
  });

  const data = await response.json();
  if (data.access_token) {
    localStorage.setItem('spotify_access_token', data.access_token);
    localStorage.setItem('spotify_token_expiry', Date.now() + data.expires_in * 1000);
    window.location.href = '/index.html'; // Adjust if needed
  } else {
    document.body.textContent = 'Token request failed: ' + JSON.stringify(data);
  }
})();
</script>
