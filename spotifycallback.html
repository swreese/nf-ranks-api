<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spotify Auth Callback</title>
</head>
<body>
  <p>Processing Spotify authentication...</p>
  <script>
    async function exchangeCodeForToken(code, codeVerifier) {
      const params = new URLSearchParams();
      params.append('client_id', '4074591da485478f9e5154af0e4d81f4');
      params.append('grant_type', 'authorization_code');
      params.append('code', code);
      params.append('redirect_uri', 'https://swreese.github.io/nf-ranks-api/spotifycallback.html');
      params.append('code_verifier', codeVerifier);

      const response = await fetch('https://accounts.spotify.com/api/token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: params.toString(),
      });

      if (!response.ok) {
        const errorText = await response.text();
        alert('Failed to get access token: ' + errorText);
        return null;
      }
      return await response.json();
    }

    (async () => {
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const error = params.get('error');
      if (error) {
        alert('Spotify authorization error: ' + error);
        window.close();
        return;
      }
      if (!code) {
        alert('No authorization code found');
        window.close();
        return;
      }
      const codeVerifier = localStorage.getItem('spotify_code_verifier');
      if (!codeVerifier) {
        alert('No code verifier found in localStorage');
        window.close();
        return;
      }

      const tokenResponse = await exchangeCodeForToken(code, codeVerifier);
      if (!tokenResponse) {
        window.close();
        return;
      }

      const { access_token, expires_in, refresh_token } = tokenResponse;

      // Store tokens and expiry timestamp in localStorage
      localStorage.setItem('spotify_access_token', access_token);
      localStorage.setItem('spotify_token_expiry', Date.now() + expires_in * 1000);
      localStorage.setItem('spotify_refresh_token', refresh_token);

      // Remove code verifier since no longer needed
      localStorage.removeItem('spotify_code_verifier');

      // Close this popup or redirect back to your main page
      window.location.href = 'https://swreese.github.io/nf-ranks-api/';
    })();
  </script>
</body>
</html>
