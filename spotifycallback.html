<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spotify Callback</title>
</head>
<body>
  <script>
    const CLIENT_ID = '4074591da485478f9e5154af0e4d81f4';
    const REDIRECT_URI = 'https://swreese.github.io/nf-ranks-api/';
    const TOKEN_URL = 'https://accounts.spotify.com/api/token';

    async function getAccessToken(code, codeVerifier) {
      const params = new URLSearchParams();
      params.append('client_id', CLIENT_ID);
      params.append('grant_type', 'authorization_code');
      params.append('code', code);
      params.append('redirect_uri', REDIRECT_URI);
      params.append('code_verifier', codeVerifier);

      const response = await fetch(TOKEN_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: params
      });

      if (!response.ok) {
        const err = await response.json();
        throw new Error(err.error_description || 'Token exchange failed');
      }

      return response.json();
    }

    async function main() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const codeVerifier = localStorage.getItem('spotify_code_verifier');

      if (!code || !codeVerifier) {
        alert('Missing code or verifier');
        return;
      }

      try {
        const tokenResponse = await getAccessToken(code, codeVerifier);
        const { access_token, expires_in } = tokenResponse;

        localStorage.setItem('spotify_access_token', access_token);
        localStorage.setItem('spotify_token_expiry', (Date.now() + expires_in * 1000).toString());

        // Done â€” now redirect back to main page
        window.location.href = REDIRECT_URI;
      } catch (e) {
        alert('Error getting access token: ' + e.message);
      }
    }

    main();
  </script>
</body>
</html>
